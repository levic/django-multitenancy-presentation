<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/blood.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">

		<style>
			.reveal section.left {
				text-align: left;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

				<!-- =============================================================== -->
				<section>
					<h1 class="r-fit-text">Multi-Tenancy<br/>Strategies<br/>with<br/>Django+PostgreSQL</h1>
				</section>

				<section>
					<h2>Problem Statement</h2>
					<p>We've using Django & PostgresQL on our website.</p>
					<p>How can we ensure users don't see data that doesn't belong to them?</p>
					<p class="fragment fade-in">"Tenancy": logically isolated set of data</p>

					<aside class="notes">
						Particular focus: what can we do to ensure that developer mistakes don't allow data leakage?

						What is a tenant? Could be a company (multiple users), could be a single user's data
							Example gmail,
					</aside>
				</section>

				<section>
					<h2>Talk Outline</h2>
					<ol>
						<li>Django permissions</li>
						<li>Multiple apps, multiple databases</li>
						<li>Single app, multiple databases</li>
						<li><b>Single app, single database</b></li>
					</ol>

				</section>

				<!-- =============================================================== -->
				<section>
					<section class="left">
						<h2>Django Permissions</h2>
						<div>
							<p>Default System:</p>
							<pre>
								<code data-trim data-noescape>
									user.has_perm("my_app.change_book")
								</code>
							</pre>
							<ul>
								<li>Quite Limited</li>
							</ul>
						</div>

					</section>

					<section class="left">
						<h2>Django Permissions</h2>
						<div>
							<p>Better Alternative:</p>
							<pre>
								<code data-trim data-noescape>
									user.has_perm("my_app.change_book", book)
								</code>
							</pre>
							<ul>
								<li>Can use 3rd-party packages (eg <code>rules</code>)</li>
								<li>Roll your own <code>AUTHENTICATION_BACKEND</code></li>
								<li>Remember to update CBVs
									<ul>
										<li>Django System Checks</li>
									</ul>
								</li>
							</ul>
						</div>

					</section>
				</section>

				<!-- =============================================================== -->
				<section>
					<section class="left">
						<h2 class="r-fit-text">Multiple App Servers,<br/>Multiple Databases</h2>
						<div>
							<ul>
								<li>✅ Code Simplicity</li>
								<li>✅ Best Possible Isolation</li>
								<li>❌ Scalability</li>
								<li>❌ Cross-Tenancy Queries</li>
								<li>❌ Administration, Deployment </li>
							</ul>
						</div>


					</section>
				</section>

				<!-- =============================================================== -->
				<section>
					<section class="left">
						<h2 class="r-fit-text">Single App Server,<br/>Multiple Databases</h2>
					<d	iv>
							<ul>
								<li>Implement with middleware doing custom DB routing</li>
								<li>✅ Code Simplicity</li>
								<li>✅ Good Isolation </li>
								<li>❌ Scalability</li>
								<li>❌ Cross-Tenancy Queries</li>
								<li>❌ Administration, Deployment </li>
							</ul>
						</div>


					</section>

					<section class="left">
						<h2 class="r-fit-text">Single App Server,<br/>Multiple <strike>Databases</strike> Schemas</h2>
						<p>Schema: namespace for postgres databases</p>
					<di	v>
							<ul>
								<li><code>django-tenants</code></li>
								<li>✅ Code Simplicity</li>
								<li>✅ Good Isolation </li>
								<li>Scalability</li>
								<li>Cross-Tenancy Queries</li>
								<li>⚠️ Transaction limits, connection pooling</li>
							</ul>
						</div>


					</section>
				</section>

				<!-- =============================================================== -->
				<section>

					<section class="left">
						<h2 class="r-fit-text">Single App Server,<br/> Single Database</h2>
						<div>
							<ul>
								<li>Django Managers</li>
								<li>Denormalisation</li>
								<li>Postgres Triggers + RLS</li>
								<li>Postgres Users + RLS</li>
							</ul>
						</div>
					</section>

					<section class="left">
						<h2 class="r-fit-text">Single App Server,<br/> Single Database</h2>
						<div>
							<ul>
								<li>❌ Code Simplicity</li>
								<li>Isolation </li>
								<li>✅ Scalability</li>
								<li>✅ Cross-Tenancy Queries</li>
							</ul>
						</div>
					</section>

				</section>

				<!-- =============================================================== -->
				<section>

					<section class="left">
						<h2 class="r-fit-text">Custom Model Managers</h2>
						<p>Standardised Tenancy Filter</p>
						<pre>
							<code data-trim data-noescape class="language-python">
								class ProjectQuerySet(QuerySet):
									def filter_tenant(queryset, tenant):
										return self.queryset.filter(account__tenant_id=tenant)

								class Project(Model):
									objects = Manager.from_queryset(ProjectQuerySet)()
							</code>
						</pre>
						<ul>
							<li>❌ Non-ORM queries</li>
						</ul>


					</section>

					<section class="left">
						<h2 class="r-fit-text">Custom Model Managers</h2>
						<p>Traversing models to get to tenant:</p>
						<pre>
							<code data-trim data-noescape>
								class TaskQuerySet(QuerySet):
									def filter_tenant(queryset, tenant):
										return self.queryset.filter(
											project__account__tenant_id=tenant
										)
							</code>
						</pre>


					</section>

					<section class="left">
						<h2 class="r-fit-text">Mandatory Tenant Filtering</h2>
						<ul>
							<li>Log a warning / Raise an exception</li>
							<li><code>_base_manager</code> vs <code>_default_manager</code> TODO: re-test this</li>
							<li>⚠️ Foreign key traversal leakage</li>
						</ul>

					</section>

				</section>

				<!-- =============================================================== -->
				<section>

					<section class="left">
						<h2 class="r-fit-text">Tenancy Denormalisation</h2>
						<p>Denormalise the tenant ID into every table</p>
						<ul>
							<li><code>django-multitenant</code></li>
							<li>✅ Code Simplicity</li>
							<li>Isolation </li>
							<li>✅ Scalability</li>
							<li>Cross-Tenancy Queries</li>
							<li>✅ Administration, Deployment </li>
							<li>Much harder to move data between tenants</li>
							<li>Standard denormalisation caveats; esp write limits</li>
						</ul>


					</section>

				</section>

				<!-- =============================================================== -->
				<section>

					<section class="left">
						<h2 class="r-fit-text">Postgres Triggers,<br />Row-level Security</h2>
						<p>Assumes tenant ID denormalised</p>
						<ul>
							<li> ... </li>
						</ul>


					</section>

				</section>

				<!-- =============================================================== -->
				<section>

					<section class="left">
						<h2 class="r-fit-text">Postgres Users,<br />Row-level Security</h2>
						<p>Assumes tenant ID denormalised</p>
						<ul>
							<li> ... </li>
						</ul>


					</section>

				</section>

				<!-- =============================================================== -->


			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [
					RevealMarkdown,
					RevealHighlight,
					RevealNotes,
				]
			});
		</script>
	</body>
</html>